import { useMemo } from 'react';
import { motion } from 'motion/react';
import svgPaths from "../imports/svg-qebtmxta3p";
import joyBlindboxTitle from "../assets/joyblindbox .png";
import imgImage11 from "figma:asset/475038219007e11e89f14c38502ca66e5fbc297e.png";
import imgImage12 from "figma:asset/481ec9271992b35c78654813354c17a1bbe7b8b3.png";
import imgImage13 from "figma:asset/dcf8b305885a632a490f729fe314980e8742e12a.png";
import imgHappy19496721 from "figma:asset/d55f0c6f64187b2aff71cc2cc23da08b81665f02.png";
import type { Recommendation } from '../types';

function Frame() {
  return (
    <div className="absolute h-[13.066px] left-[32.61px] top-[16.31px] w-[7.95px]">
      <div className="absolute inset-[-10.14%_-16.67%]">
        <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 10.6003 15.7163">
          <g>
            <path d="M1.32531 1.32495V5.74144" stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
            <path d="M9.27493 1.32497V5.74147" stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
            <path d={svgPaths.p381fe200} stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
          </g>
        </svg>
      </div>
    </div>
  );
}

function Frame1() {
  return (
    <div className="absolute h-[13.066px] left-[224.22px] top-[17.12px] w-[7.95px]">
      <div className="absolute inset-[-10.14%_-16.67%]">
        <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 10.6003 15.7163">
          <g>
            <path d="M1.32531 1.32495V5.74144" stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
            <path d="M9.27491 1.32496V5.74145" stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
            <path d={svgPaths.p381fe200} stroke="var(--stroke-0, #2B2A2A)" strokeLinecap="round" strokeWidth="2.6499" />
          </g>
        </svg>
      </div>
    </div>
  );
}

function Frame3() {
  return (
    <div className="absolute h-[40.768px] left-[61.15px] top-[39.14px] w-[269.882px]">
      <img
        alt="JOYBLINDBOX"
        className="absolute left-0 top-0 h-full w-full object-contain"
        src={joyBlindboxTitle}
      />
      <Frame />
      <Frame1 />
    </div>
  );
}

function Frame4() {
  return (
    <div className="h-[11.055px] relative w-[73.185px]">
      <img
        alt="JOYBLINDBOX"
        className="absolute left-0 top-0 h-full w-full object-contain"
        src={joyBlindboxTitle}
      />
      <div className="absolute h-[1.198px] left-[8.84px] top-[4.42px] w-0">
        <div className="absolute inset-[-30%_-0.36px]">
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 0.718586 1.91623">
            <path d="M0.359293 0.359293V1.55694" stroke="var(--stroke-0, #A28F7E)" strokeLinecap="round" strokeWidth="0.718586" />
          </svg>
        </div>
      </div>
      <div className="absolute h-[1.198px] left-[11px] top-[4.42px] w-0">
        <div className="absolute inset-[-30%_-0.36px]">
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 0.718586 1.91623">
            <path d="M0.359293 0.359293V1.55694" stroke="var(--stroke-0, #A28F7E)" strokeLinecap="round" strokeWidth="0.718586" />
          </svg>
        </div>
      </div>
      <div className="absolute h-[1.198px] left-[60.8px] top-[4.64px] w-0">
        <div className="absolute inset-[-30%_-0.36px]">
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 0.718586 1.91623">
            <path d="M0.359293 0.359293V1.55694" stroke="var(--stroke-0, #A28F7E)" strokeLinecap="round" strokeWidth="0.718586" />
          </svg>
        </div>
      </div>
      <div className="absolute h-[1.198px] left-[62.96px] top-[4.64px] w-0">
        <div className="absolute inset-[-30%_-0.36px]">
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 0.718586 1.91623">
            <path d="M0.359293 0.359293V1.55694" stroke="var(--stroke-0, #A28F7E)" strokeLinecap="round" strokeWidth="0.718586" />
          </svg>
        </div>
      </div>
    </div>
  );
}

function Component2() {
  return (
    <div className="absolute bottom-[-0.1px] h-[35.78px] left-0 right-[0.27%]">
      <div className="-translate-x-1/2 absolute bg-black bottom-[8.2px] h-[5.262px] left-[calc(50%-0.32px)] rounded-[105.235px] w-[141.015px]" />
    </div>
  );
}

function BarChart() {
  return (
    <div className="h-[27.394px] relative shrink-0 w-[29.677px]">
      <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 29.6769 27.394">
        <g>
          <path d={svgPaths.p1b098100} stroke="var(--stroke-0, #4B4B4B)" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.2243" />
        </g>
      </svg>
    </div>
  );
}

function Settings() {
  return (
    <div className="h-[22.828px] relative shrink-0 w-[23.325px]">
      <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 23.3246 22.8284">
        <g clipPath="url(#clip0_settings)">
          <g>
            <path d={svgPaths.p1daa5200} stroke="var(--stroke-0, #4B4B4B)" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.98508" />
            <path d={svgPaths.p2aef6140} stroke="var(--stroke-0, #4B4B4B)" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.98508" />
          </g>
        </g>
        <defs>
          <clipPath id="clip0_settings">
            <rect fill="white" height="22.8284" width="23.3246" />
          </clipPath>
        </defs>
      </svg>
    </div>
  );
}

function Frame2({ onNavigateChat, onNavigateTheorem, onNavigateHome }: { onNavigateChat: () => void; onNavigateTheorem: () => void; onNavigateHome: () => void }) {
  return (
    <div className="absolute content-stretch flex gap-[38.047px] items-end left-[54.63px] top-[14.68px]">
      <button onClick={onNavigateChat} className="relative rounded-[3.044px] shrink-0 size-[27.394px] transition-transform hover:scale-110 active:scale-95">
        <img alt="" className="absolute inset-0 max-w-none object-cover opacity-70 pointer-events-none rounded-[3.044px] size-full" src={imgImage12} />
      </button>
      <button onClick={onNavigateTheorem} className="relative shrink-0 size-[25.111px] transition-transform hover:scale-110 active:scale-95">
        <img alt="" className="absolute inset-0 max-w-none object-cover opacity-70 pointer-events-none size-full" src={imgImage13} />
      </button>
      <button onClick={onNavigateHome} className="relative shrink-0 size-[27.394px] transition-transform hover:scale-110 active:scale-95">
        <img alt="" className="absolute inset-0 max-w-none object-cover opacity-70 pointer-events-none size-full" src={imgHappy19496721} />
      </button>
      <BarChart />
      <Settings />
    </div>
  );
}

function Component1({ onNavigateChat, onNavigateTheorem, onNavigateHome }: { onNavigateChat: () => void; onNavigateTheorem: () => void; onNavigateHome: () => void }) {
  return (
    <div className="absolute bg-[rgba(255,255,255,0)] h-[84.797px] left-[-1.63px] top-[766.43px] w-[394.631px]">
      <Component2 />
      <Frame2 onNavigateChat={onNavigateChat} onNavigateTheorem={onNavigateTheorem} onNavigateHome={onNavigateHome} />
    </div>
  );
}

interface BoxRevealPageProps {
  onNavigateChat: () => void;
  onNavigateTheorem: () => void;
  onNavigateHome: () => void;
  energyLevel: number;
  recommendations?: Recommendation[];
  isLoading?: boolean;
}

const giftColors = ['#fc7371', '#FFD666', '#8697F6', '#A9D66A', '#FFAB52'];

const fallbackGifts = [
  { title: 'Yarn', message: 'It is time to feel some warmth outside.' },
  { title: 'Sunshine', message: 'Brighten your day with some outdoor time!' },
  { title: 'Book', message: 'Time to dive into a new story.' },
  { title: 'Tea', message: 'Take a break and enjoy a warm cup.' },
  { title: 'Music', message: 'Let the rhythm lift your spirits!' }
];

export default function BoxRevealPage({ onNavigateChat, onNavigateTheorem, onNavigateHome, energyLevel, recommendations, isLoading }: BoxRevealPageProps) {
  // Select color based on energy level
  const giftIndex = Math.min(Math.floor((energyLevel / 100) * giftColors.length), giftColors.length - 1);
  const displayColor = giftColors[giftIndex];

  // Pick the highest-confidence AI recommendation (stable across re-renders)
  const recommendation = useMemo(() => {
    if (recommendations && recommendations.length > 0) {
      // Sort by confidence descending, pick the best one
      const sorted = [...recommendations].sort((a, b) => (b.confidence ?? 0) - (a.confidence ?? 0));
      return sorted[0];
    }
    return null;
  }, [recommendations]);

  const fallback = fallbackGifts[giftIndex];
  const displayTitle = recommendation?.title ?? fallback.title;
  const displayMessage = recommendation?.description ?? fallback.message;

  // Background circles for decoration
  const circles = [
    { left: 5.71, top: 307.39, size: 81.535, color: '#EBDFCE' },
    { left: 49.74, top: 375.06, size: 87.243, color: '#F7E7D0' },
    { left: 75.01, top: 320.43, size: 32.614, color: '#FFCECE' },
    { left: 307.39, top: 410.12, size: 32.614, color: '#FFCECE' },
    { left: 238.08, top: 287.82, size: 32.614, color: '#BDD3DB' },
    { left: 267.44, top: 235.64, size: 47.29, color: '#CAD4EF' },
    { left: 93.77, top: 256.02, size: 53.813, color: '#FFD6AA' },
    { left: 291.08, top: 299.23, size: 97.842, color: '#F7E7D0' }
  ];

  return (
    <div className="bg-white relative size-full overflow-hidden flex flex-col">
      {/* Box visual area - fixed height */}
      <div className="relative shrink-0" style={{ height: 490 }}>
        {/* Background decoration circles */}
        {circles.map((circle, index) => (
          <motion.div
            key={index}
            className="absolute"
            style={{
              left: `${circle.left}px`,
              top: `${circle.top}px`,
              width: `${circle.size}px`,
              height: `${circle.size}px`
            }}
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{ duration: 0.5, delay: index * 0.1 }}
          >
            <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox={`0 0 ${circle.size} ${circle.size}`}>
              <circle cx={circle.size / 2} cy={circle.size / 2} fill={circle.color} r={circle.size / 2} />
            </svg>
          </motion.div>
        ))}

        {/* Shadow */}
        <div className="absolute h-[49.737px] left-[172.04px] top-[413.38px] w-[123.934px]">
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 123.934 49.7365">
            <ellipse cx="61.9668" cy="24.8683" fill="var(--fill-0, #B4B4B4)" rx="61.9668" ry="24.8683" />
          </svg>
        </div>

        <Frame3 />

        {/* Box bottom */}
        <motion.div
          className="absolute h-[114.886px] left-[118.44px] top-[351.68px] w-[156.942px]"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
        >
          <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 156.798 114.738">
            <g>
              <path d={svgPaths.p3475ee00} fill="#96816F" fillOpacity="0.8" />
              <path d={svgPaths.p2ef91080} fill="#CCB69B" />
              <path d={svgPaths.p3c84da00} fill="#CCB69B" />
              <path d={svgPaths.p9723740} fill="var(--fill-0, #FCE6CC)" />
            </g>
          </svg>
        </motion.div>

        {/* Gift item */}
        <motion.div
          className="absolute left-[164.7px] size-[89.689px] top-[309.83px]"
          initial={{ scale: 0, rotate: -45, opacity: 0 }}
          animate={{ scale: 1, rotate: 0, opacity: 1 }}
          transition={{ duration: 0.8, type: "spring", bounce: 0.5 }}
        >
          <img alt="" className="absolute inset-0 max-w-none object-cover pointer-events-none size-full" src={imgImage11} />
        </motion.div>

        {/* Box top (lid) - moved to side */}
        <motion.div
          className="absolute h-[104.628px] left-[114.15px] top-[199.76px] w-[158.994px]"
          initial={{ x: 0, y: 0, rotate: 0 }}
          animate={{ x: -80, y: 60, rotate: -25 }}
          transition={{ duration: 0.8, delay: 0.2 }}
        >
          <div className="absolute inset-[0.13%_0_0.19%_0]">
            <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 158.994 104.293">
              <g>
                <path d={svgPaths.p32183f0} fill="#96816F" />
                <path d={svgPaths.p2c5dd500} fill="var(--fill-0, #B19984)" />
                <path d={svgPaths.p387db900} fill="var(--fill-0, #B19984)" />
                <path d={svgPaths.p2842c400} fill="var(--fill-0, #B19984)" />
              </g>
            </svg>
          </div>
        </motion.div>

        {/* Box label on bottom */}
        <div className="absolute flex h-[34.658px] items-center justify-center left-[134.72px] top-[425.45px] w-[72.719px]">
          <div className="flex-none rotate-[19.33deg]">
            <Frame4 />
          </div>
        </div>
      </div>

      {/* Text content area - flows below the box */}
      <div className="flex-1 flex flex-col items-center justify-center px-[40px] overflow-y-auto min-h-0">
        {isLoading ? (
          <motion.div
            className="flex flex-col items-center gap-3"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.3 }}
          >
            <div className="w-6 h-6 border-2 border-[#A9D66A] border-t-transparent rounded-full animate-spin" />
            <p className="font-['Istok_Web:Regular',sans-serif] text-[14px] text-[#999] text-center">
              Crafting your joy recommendation...
            </p>
          </motion.div>
        ) : (
          <>
            {/* Congratulations */}
            <motion.div
              className="font-['Istok_Web:Regular',sans-serif] text-[15px] text-[#3a3a3a] text-center leading-relaxed"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.5 }}
            >
              <p className="mb-1">Congratulations!</p>
              <p>
                {`You got `}
                <span className="font-['Istok_Web:Bold',sans-serif]" style={{ color: displayColor }}>
                  {displayTitle}
                </span>
                {` !`}
              </p>
            </motion.div>

            {/* Description */}
            <motion.p
              className="font-['Istok_Web:Regular',sans-serif] text-[14px] text-[#3a3a3a] text-center leading-relaxed mt-3"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.5, delay: 0.8 }}
            >
              {displayMessage}
            </motion.p>

            {/* Energy match reason */}
            {recommendation?.energy_match && (
              <motion.p
                className="font-['Istok_Web:Regular',sans-serif] text-[12px] text-[#999] text-center mt-2"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ duration: 0.5, delay: 1 }}
              >
                {recommendation.energy_match}
              </motion.p>
            )}

            {/* Back to Home button */}
            <motion.button
              onClick={onNavigateHome}
              className="mt-4 w-[140px] h-[50px] bg-[#A9D66A] rounded-[25px] shadow-[0px_4px_8px_0px_rgba(0,0,0,0.15)] transition-transform hover:scale-105 active:scale-95 shrink-0"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 1.2 }}
            >
              <p className="font-['Istok_Web:Bold',sans-serif] text-[16px] text-white">Back to Home</p>
            </motion.button>
          </>
        )}
      </div>

      {/* Bottom nav */}
      <Component1 onNavigateChat={onNavigateChat} onNavigateTheorem={onNavigateTheorem} onNavigateHome={onNavigateHome} />
    </div>
  );
}
